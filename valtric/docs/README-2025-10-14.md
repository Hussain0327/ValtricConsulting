# 2025-10-14 Daily Readme

## Where Things Stand
- `make_payload.py` now generates a `payload.json` using `text-embedding-3-small` so embeddings are 1536-dim and match `Vector(1536)` in both Postgres and Supabase (`valtric/backend/make_payload.py`).
- `/foundry/ingest` writes deals/chunks locally and attempts Supabase upserts via the new client (`app/services/foundry/pipeline.py`, `app/integrations/supabase.py`).
- Retrieval prefers Supabase’s `match_chunks` RPC and falls back to local pgvector (`app/services/retrieve.py`). `/analyze` logs `analysis_classification` + timing metrics (`app/services/consultant.py`).
- Supabase schema + RPC lives in `supabase.sql`. It now uses `IF NOT EXISTS` guards and includes the `match_chunks` function.
- One-time sync script (`python -m scripts.sync_supabase`) still finds zero rows because supabase insert is failing before local commit.

## Blockers / Open Issues
- Supabase returns `401 Invalid API key` or `403 permission denied` when `/foundry/ingest` tries to `bulk_upsert` into `documents`. That means the service-role key in `.env` is either wrong, truncated, or not bypassing RLS.
- Because of the upstream 401/403, the ingestion endpoint fails with 500, so Supabase never receives documents/chunks/embeddings. Local Postgres still commits fine once Supabase is skipped.

## What to Do Tomorrow
1. **Verify Supabase credentials**
   - Grab the exact Service Role key from Supabase Dashboard → Settings → API.
   - Update `valtric/backend/.env` with the full `SUPABASE_SERVICE_ROLE_KEY` (no whitespace/newlines).
   - From the shell (with the key exported), run:
     ```bash
     curl -i "https://wupfktkhluphvpfyqwcm.supabase.co/rest/v1/documents?select=id&limit=1" \
       -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
       -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}"
     ```
     Expect `200 OK` even if the body is empty. If you still get 401/403, regenerate the service-role key and update `.env` again.
   - Once curl succeeds, restart uvicorn so the app picks up the new env vars.

2. **Run ingest end-to-end**
   - Quick sanity check: `python make_payload.py` + `curl -X POST http://127.0.0.1:8000/foundry/ingest -H "Content-Type: application/json" -d @payload.json`.
- For richer seed data, use the new helper script once OpenAI key is exported: `python scripts/seed_foundry.py --host http://127.0.0.1:8000`.
- Confirm the ingest response shows `documents_ingested/chunks_ingested/embeddings_ingested` and Supabase tables update.
- You can also ingest JSONL batches (e.g., `doc.js` seeds) via `python scripts/ingest_jsonl.py /path/to/seed.jsonl --host http://127.0.0.1:8000`.

3. **Validate retrieval**
   - `curl -s -X POST http://127.0.0.1:8000/analyze -H "Content-Type: application/json" -d '{"deal_id": <id from ingest>, "question":"Compare the SaaS deal..." }'`
   - In the uvicorn log you should now see `supabase_vector_search` timings without fallback warnings.
   - The response `comps_used`/`reasoning` should reference the chunk text you ingested.

4. **Clean up**
   - `rm make_payload.py` if you don’t need it anymore (payload.json can stay for reruns).
   - Commit the code (excluding `.env` and any keys).

5. **Next Enhancements**
   - Once Supabase writes succeed, extend the ingest pipeline to log `pipeline_runs`/`index_snapshots` and optionally generate `evidence_packs`.
   - Add integration tests that mock Supabase HTTP calls so CI doesn’t hit the real API.
   - Decide how to persist triage summaries/lineage info for the Foundry UI.

## Quick Commands
```bash
# Regenerate payload (requires OPENAI_API_KEY exported)
python make_payload.py

# Ingest payload (with uvicorn running)
curl -X POST http://127.0.0.1:8000/foundry/ingest \
  -H "Content-Type: application/json" \
  -d @payload.json

# Supabase insert sanity check
curl -i "https://wupfktkhluphvpfyqwcm.supabase.co/rest/v1/documents?select=id&limit=1" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}"

# Analyze with the new deal
curl -s -X POST http://127.0.0.1:8000/analyze \
  -H "Content-Type: application/json" \
  -d '{"deal_id": <deal_id>, "question": "Compare this SaaS deal..." }'
```

Feel free to clear this README tomorrow after copying the relevant items into your working notes.***
codex resume 0199dfcc-bdff-7683-81de-a87e4c25adc5
